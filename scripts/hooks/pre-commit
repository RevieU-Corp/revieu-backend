#!/bin/bash

# Pre-commit hook to prevent committing unencrypted secrets
# This hook checks if any secrets.yaml files are being committed

RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Check if any secrets.yaml files are being committed
if git diff --cached --name-only | grep -q "secrets\.yaml$"; then
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}âŒ COMMIT BLOCKED: Unencrypted secrets detected!${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${YELLOW}You are trying to commit unencrypted secrets.yaml files:${NC}"
    git diff --cached --name-only | grep "secrets\.yaml$" | sed 's/^/  - /'
    echo ""
    echo -e "${YELLOW}ğŸ”’ Please encrypt your secrets first:${NC}"
    echo ""
    echo "  1. Run the seal-secrets script:"
    echo "     ./scripts/seal-secrets.sh"
    echo ""
    echo "  2. Commit the encrypted file instead:"
    echo "     git add apps/*/configs/sealed-secrets.yaml"
    echo "     git commit -m 'chore: update sealed secrets'"
    echo ""
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    exit 1
fi

# All checks passed
exit 0
